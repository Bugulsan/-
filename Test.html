<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>무료 노선도 편집기</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body { margin: 0; }
      #map { height: 100vh; width: 100%; }
      #toolbar {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        z-index: 999;
      }
      input, button, select { margin: 4px; }
    </style>
  </head>
  <body>
    <div id="toolbar">
      <select id="mode">
        <option value="line">노선 그리기</option>
        <option value="station">역 추가</option>
      </select>
      <input type="color" id="color" value="#ff0000">
      <button id="newLine">새 노선</button>
      <button id="save">저장</button>
      <button id="load">불러오기</button>
      <input type="file" id="fileInput" style="display:none;">
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      const map = L.map('map').setView([37.5665, 126.9780], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      let mode = 'line';
      let drawing = false;
      let currentLine = null;
      let currentLineData = { name: '', color: '', path: [] };
      const lines = [];
      const stations = [];

      document.getElementById("mode").onchange = e => mode = e.target.value;

      document.getElementById("newLine").onclick = () => {
        const name = prompt("새 노선 이름을 입력하세요:");
        if (!name) return;
        const color = document.getElementById("color").value;
        currentLineData = { name, color, path: [] };
        drawing = true;
        currentLine = null;
        alert(`${name} 노선 그리기를 시작합니다.`);
      };

      map.on('click', e => {
        if (mode === 'line' && drawing) {
          currentLineData.path.push([e.latlng.lat, e.latlng.lng]);
          if (!currentLine) {
            currentLine = L.polyline(currentLineData.path, { color: currentLineData.color, weight: 4 }).addTo(map);
          } else {
            currentLine.setLatLngs(currentLineData.path);
          }
        } else if (mode === 'station') {
          const name = prompt("역 이름을 입력하세요:");
          if (name) {
            const marker = L.marker(e.latlng).addTo(map).bindPopup(name);
            stations.push({ name, lat: e.latlng.lat, lng: e.latlng.lng });
          }
        }
      });

      map.on('contextmenu', () => { // 오른쪽 클릭으로 노선 종료
        if (drawing && currentLine) {
          lines.push({ ...currentLineData });
          drawing = false;
          currentLine = null;
          alert(`${currentLineData.name} 노선이 저장되었습니다.`);
        }
      });

      document.getElementById("save").onclick = () => {
        const data = { lines, stations };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "노선도.json";
        a.click();
        URL.revokeObjectURL(url);
      };

      document.getElementById("load").onclick = () => {
        document.getElementById("fileInput").click();
      };

      document.getElementById("fileInput").onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = evt => {
          const data = JSON.parse(evt.target.result);
          data.lines.forEach(line => {
            L.polyline(line.path, { color: line.color, weight: 4 }).addTo(map);
            lines.push(line);
          });
          data.stations.forEach(st => {
            L.marker([st.lat, st.lng]).addTo(map).bindPopup(st.name);
            stations.push(st);
          });
          alert("노선도 불러오기 완료!");
        };
        reader.readAsText(file);
      };
    </script>
  </body>
</html>
